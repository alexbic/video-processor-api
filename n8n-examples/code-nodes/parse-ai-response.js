// ═══════════════════════════════════════════════════════════════════════════
// 🔧 N8N CODE NODE: Parse AI Agent Response (Clean JSON or Markdown)
// ═══════════════════════════════════════════════════════════════════════════
//
// НАЗНАЧЕНИЕ:
// Извлекает чистый JSON из ответа AI агента (Claude, OpenAI, etc.)
//
// ПОДДЕРЖИВАЕМЫЕ ФОРМАТЫ:
// 1. ✅ Чистый JSON (приоритет) - парсится напрямую
// 2. ✅ Markdown блок ```json...``` - для обратной совместимости
//
// ИСПОЛЬЗОВАНИЕ В N8N:
// 1. Вход: $input.item.json.output содержит ответ AI агента
// 2. Выход: массив с одним элементом [{json: parsedObject}]
//
// ═══════════════════════════════════════════════════════════════════════════

const item = $input.item;
const rawOutput = item.json.output;
let cleanJson = null;

// ══════════════════════════════════════════════════════════════════════════
// СТРАТЕГИЯ 1: Попытка парсинга чистого JSON (новый формат, приоритет)
// ══════════════════════════════════════════════════════════════════════════
try {
	cleanJson = JSON.parse(rawOutput);
} catch (directParseError) {

	// ══════════════════════════════════════════════════════════════════════
	// СТРАТЕГИЯ 2: Извлечение из markdown блока ```json...```
	// (для обратной совместимости со старыми промтами)
	// ══════════════════════════════════════════════════════════════════════
	const markdownMatch = rawOutput.match(/```json\s*([\s\S]*?)\s*```/);

	if (markdownMatch && markdownMatch[1]) {
		try {
			cleanJson = JSON.parse(markdownMatch[1]);
		} catch (markdownParseError) {
			cleanJson = {
				error: 'Failed to parse JSON content from markdown block',
				raw_output: rawOutput,
				parse_error: markdownParseError.message
			};
		}
	} else {
		// ══════════════════════════════════════════════════════════════════
		// СТРАТЕГИЯ 3: Если ни один формат не подошёл - возвращаем ошибку
		// ══════════════════════════════════════════════════════════════════
		cleanJson = {
			error: 'Invalid AI response format',
			details: 'Response is neither valid JSON nor markdown JSON block',
			raw_output: rawOutput,
			direct_parse_error: directParseError.message
		};
	}
}

// ══════════════════════════════════════════════════════════════════════════
// ВАЛИДАЦИЯ РЕЗУЛЬТАТА
// ══════════════════════════════════════════════════════════════════════════
if (cleanJson && !cleanJson.error) {
	// Проверяем базовую структуру ответа (валидация происходит в потоке данных)
}

// ══════════════════════════════════════════════════════════════════════════
// ВОЗВРАТ РЕЗУЛЬТАТА
// ══════════════════════════════════════════════════════════════════════════
// Возвращаем массив с ОДНИМ элементом для n8n
return [{ json: cleanJson }];
