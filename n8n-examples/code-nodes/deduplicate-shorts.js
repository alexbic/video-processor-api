// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ”§ N8N CODE NODE: Deduplicate Shorts After Block Processing
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//
// ĞĞĞ—ĞĞĞ§Ğ•ĞĞ˜Ğ•:
// ĞĞ±ÑŠĞµĞ´Ğ¸Ğ½ÑĞµÑ‚ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¸Ñ… Ğ±Ğ»Ğ¾ĞºĞ¾Ğ² Ğ¸ ÑƒĞ´Ğ°Ğ»ÑĞµÑ‚ Ğ´ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ‚Ñ‹
//
// ĞŸĞ ĞĞ‘Ğ›Ğ•ĞœĞ:
// ĞŸÑ€Ğ¸ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞµ Ğ±Ğ»Ğ¾ĞºĞ¾Ğ² Ñ Ğ¿ĞµÑ€ĞµĞºÑ€Ñ‹Ñ‚Ğ¸ÑĞ¼Ğ¸ (overlap zones) Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ñ‹ Ğ´ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ‚Ñ‹:
// - Block 1 ÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ shorts Ğ² Ğ·Ğ¾Ğ½Ğµ 1800-1890 (overlap AFTER)
// - Block 2 ÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ Ñ‚Ğ¾Ñ‚ Ğ¶Ğµ shorts Ğ² Ğ·Ğ¾Ğ½Ğµ 1710-1800 (overlap BEFORE)
// Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚: Ğ¾Ğ´Ğ¸Ğ½ Ğ¸ Ñ‚Ğ¾Ñ‚ Ğ¶Ğµ Ğ¼Ğ¾Ğ¼ĞµĞ½Ñ‚ Ğ¿Ğ¾ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ´Ğ²Ğ°Ğ¶Ğ´Ñ‹!
//
// Ğ Ğ•Ğ¨Ğ•ĞĞ˜Ğ•:
// ĞĞ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼ Ğ´ĞµĞ´ÑƒĞ¿Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸ Ğ¿Ğ¾ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾Ğ¼Ñƒ Ğ¿ĞµÑ€ĞµĞºÑ€Ñ‹Ñ‚Ğ¸Ñ:
// 1. Ğ¡Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ²ÑĞµ shorts Ğ¿Ğ¾ start_time
// 2. Ğ¡Ñ€Ğ°Ğ²Ğ½Ğ¸Ğ²Ğ°ĞµĞ¼ ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ shorts Ñ Ğ¿Ğ¾ÑĞ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğ¼Ğ¸
// 3. Ğ•ÑĞ»Ğ¸ Ğ¿ĞµÑ€ĞµĞºÑ€Ñ‹Ñ‚Ğ¸Ğµ > 50% â†’ ÑÑ‡Ğ¸Ñ‚Ğ°ĞµĞ¼ Ğ´ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ‚Ğ¾Ğ¼
// 4. ĞÑÑ‚Ğ°Ğ²Ğ»ÑĞµĞ¼ shorts Ñ Ğ›Ğ£Ğ§Ğ¨Ğ˜Ğœ virality_score
//
// Ğ’Ğ¥ĞĞ”:
// {
//   source_video_url: "http://youtube-downloader:5000/download/a3b82705-11f8-404a-86b8-16553ae4397d/video_20251127_230049.mp4",
//   shorts: [
//     {
//       start: 637.19,
//       end: 686.29,
//       title: "ĞŸĞ¾Ğ±ĞµĞ´Ğ° Ğ½Ğ° 1 Ğ¥ĞŸ!",
//       subtitles: [
//         { text: "Ğ¢Ğ°Ğº, Ğ½Ñƒ-ĞºĞ° Ğ´Ğ°Ğ²Ğ°Ğ¹Ñ‚Ğµ", start: 0, end: 0.76 },
//         { text: "Ğ¿Ğ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞµĞ¼ Ğ´Ğ¾Ğ±Ğ¸Ñ‚ÑŒ", start: 0.76, end: 1.8 }
//       ]
//     },
//     ...
//   ]
// }
//
// Ğ’Ğ«Ğ¥ĞĞ”:
// ĞĞ´Ğ¸Ğ½ item Ñ Ğ¾Ğ±ÑŠĞµĞ´Ğ¸Ğ½Ñ‘Ğ½Ğ½Ñ‹Ğ¼ Ğ¸ Ğ´ĞµĞ´ÑƒĞ¿Ğ»Ğ¸Ñ†Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¼ Ğ¼Ğ°ÑÑĞ¸Ğ²Ğ¾Ğ¼ shorts + ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°:
// {
//   source_video_url: "...",
//   shorts: [...],
//   stats: {
//     total_before: 12,
//     total_after: 10,
//     duplicates_removed: 2,
//     overlap_threshold: 50
//   }
// }
//
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ğ¨ĞĞ“ 1: Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ²ÑĞµ shorts Ğ¸Ğ· Ğ²ÑĞµÑ… Ğ±Ğ»Ğ¾ĞºĞ¾Ğ²
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const sourceVideoUrl = $json.source_video_url;
const allShorts = [];

for (const item of $input.all()) {
	const shorts = item.json.shorts || [];

	shorts.forEach(short => {
		// Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ source_video_url Ğº ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¼Ñƒ shorts
		short.source_video_url = sourceVideoUrl;
		allShorts.push(short);
	});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ğ¨ĞĞ“ 2: Ğ¡Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¿Ğ¾ start Ğ´Ğ»Ñ ÑÑ„Ñ„ĞµĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾Ğ³Ğ¾ ÑÑ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ñ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

allShorts.sort((a, b) => a.start - b.start);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ğ¤Ğ£ĞĞšĞ¦Ğ˜Ğ¯: Ğ’Ñ‹Ñ‡Ğ¸ÑĞ»ĞµĞ½Ğ¸Ğµ Ğ¿ĞµÑ€ĞµĞºÑ€Ñ‹Ñ‚Ğ¸Ñ Ğ´Ğ²ÑƒÑ… Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ñ… Ğ¸Ğ½Ñ‚ĞµÑ€Ğ²Ğ°Ğ»Ğ¾Ğ²
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function calculateOverlap(short1, short2) {
	const start1 = short1.start;
	const end1 = short1.end;
	const start2 = short2.start;
	const end2 = short2.end;

	// ĞĞ°Ñ…Ğ¾Ğ´Ğ¸Ğ¼ Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹ Ğ¿ĞµÑ€ĞµĞºÑ€Ñ‹Ñ‚Ğ¸Ñ
	const overlapStart = Math.max(start1, start2);
	const overlapEnd = Math.min(end1, end2);

	// Ğ•ÑĞ»Ğ¸ Ğ½ĞµÑ‚ Ğ¿ĞµÑ€ĞµĞºÑ€Ñ‹Ñ‚Ğ¸Ñ
	if (overlapStart >= overlapEnd) {
		return 0;
	}

	// Ğ”Ğ»Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ Ğ¿ĞµÑ€ĞµĞºÑ€Ñ‹Ñ‚Ğ¸Ñ
	const overlapDuration = overlapEnd - overlapStart;

	// Ğ”Ğ»Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸ shorts
	const duration1 = end1 - start1;
	const duration2 = end2 - start2;

	// ĞŸÑ€Ğ¾Ñ†ĞµĞ½Ñ‚ Ğ¿ĞµÑ€ĞµĞºÑ€Ñ‹Ñ‚Ğ¸Ñ Ğ¾Ñ‚Ğ½Ğ¾ÑĞ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ ĞœĞ•ĞĞ¬Ğ¨Ğ•Ğ“Ğ shorts
	const minDuration = Math.min(duration1, duration2);
	const overlapPercent = (overlapDuration / minDuration) * 100;

	return overlapPercent;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ğ¨ĞĞ“ 3: Ğ”ĞµĞ´ÑƒĞ¿Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ñ Ñ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸ĞµĞ¼ Ğ»ÑƒÑ‡ÑˆĞ¸Ñ… Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚Ğ¾Ğ²
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const OVERLAP_THRESHOLD = 50; // Ğ•ÑĞ»Ğ¸ Ğ¿ĞµÑ€ĞµĞºÑ€Ñ‹Ñ‚Ğ¸Ğµ > 50% â†’ Ğ´ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ‚
const deduplicated = [];
const duplicatesFound = [];

for (let i = 0; i < allShorts.length; i++) {
	const current = allShorts[i];

	// ĞŸÑ€Ğ¾Ğ¿ÑƒÑĞºĞ°ĞµĞ¼, ĞµÑĞ»Ğ¸ ÑƒĞ¶Ğµ Ğ¿Ğ¾Ğ¼ĞµÑ‡ĞµĞ½ ĞºĞ°Ğº Ğ´ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ‚
	if (current._isDuplicate) {
		continue;
	}

	let bestShort = current;
	const duplicatesOfCurrent = [];

	// Ğ¡Ñ€Ğ°Ğ²Ğ½Ğ¸Ğ²Ğ°ĞµĞ¼ Ñ Ğ¿Ğ¾ÑĞ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğ¼Ğ¸ shorts
	for (let j = i + 1; j < allShorts.length; j++) {
		const candidate = allShorts[j];

		// Ğ•ÑĞ»Ğ¸ ĞºĞ°Ğ½Ğ´Ğ¸Ğ´Ğ°Ñ‚ ÑƒĞ¶Ğµ Ğ¿Ğ¾Ğ¼ĞµÑ‡ĞµĞ½ ĞºĞ°Ğº Ğ´ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ‚ - Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑĞºĞ°ĞµĞ¼
		if (candidate._isDuplicate) {
			continue;
		}

		// ĞĞ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ: ĞµÑĞ»Ğ¸ start ĞºĞ°Ğ½Ğ´Ğ¸Ğ´Ğ°Ñ‚Ğ° Ğ´Ğ°Ğ»ĞµĞºĞ¾ - Ğ´Ğ°Ğ»ÑŒÑˆĞµ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑÑ‚ÑŒ Ğ½ĞµÑ‚ ÑĞ¼Ñ‹ÑĞ»Ğ°
		if (candidate.start > current.end) {
			break;
		}

		// Ğ’Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµĞ¼ Ğ¿ĞµÑ€ĞµĞºÑ€Ñ‹Ñ‚Ğ¸Ğµ
		const overlap = calculateOverlap(current, candidate);

		// Ğ•ÑĞ»Ğ¸ Ğ¿ĞµÑ€ĞµĞºÑ€Ñ‹Ñ‚Ğ¸Ğµ > Ğ¿Ğ¾Ñ€Ğ¾Ğ³Ğ° â†’ ÑÑ‚Ğ¾ Ğ´ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ‚!
		if (overlap > OVERLAP_THRESHOLD) {

			duplicatesOfCurrent.push(candidate);
			candidate._isDuplicate = true;

			// Ğ•ÑĞ»Ğ¸ Ñƒ ĞºĞ°Ğ½Ğ´Ğ¸Ğ´Ğ°Ñ‚Ğ° Ğ‘ĞĞ›Ğ•Ğ• Ğ ĞĞĞĞ˜Ğ™ start - Ğ±ĞµÑ€Ñ‘Ğ¼ ĞµĞ³Ğ¾ (Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¹ Ğ¿Ğ¾ÑĞ²Ğ»ÑĞµÑ‚ÑÑ)
			if (candidate.start < bestShort.start) {
				bestShort._isDuplicate = true;
				bestShort = candidate;
				candidate._isDuplicate = false;
			}
		}
	}

	// Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ»ÑƒÑ‡ÑˆĞ¸Ğ¹ Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚ Ğ² Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚
	if (!bestShort._isDuplicate) {
		// Ğ£Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ñ‚ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ğ¿Ğ¾Ğ»Ñ
		delete bestShort._isDuplicate;

		deduplicated.push(bestShort);

		if (duplicatesOfCurrent.length > 0) {
			duplicatesFound.push({
				kept: bestShort,
				removed: duplicatesOfCurrent.map(d => ({
					start: d.start,
					end: d.end,
					title: d.title
				}))
			});
		}
	}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ğ¨ĞĞ“ 4: Ğ¤Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ğ°Ñ ÑĞ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²ĞºĞ° Ğ¿Ğ¾ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° (Ñ…Ñ€Ğ¾Ğ½Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ğ¿Ğ¾Ñ€ÑĞ´Ğ¾Ğº)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

deduplicated.sort((a, b) => a.start - b.start);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ğ¡Ğ¢ĞĞ¢Ğ˜Ğ¡Ğ¢Ğ˜ĞšĞ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const stats = {
	total_before: allShorts.length,
	total_after: deduplicated.length,
	duplicates_removed: allShorts.length - deduplicated.length,
	overlap_threshold: OVERLAP_THRESHOLD
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ğ’ĞĞ—Ğ’Ğ ĞĞ¢ Ğ Ğ•Ğ—Ğ£Ğ›Ğ¬Ğ¢ĞĞ¢Ğ (Ñ‚Ğ¾Ñ‚ Ğ¶Ğµ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚, Ñ‡Ñ‚Ğ¾ Ğ¾Ñ‚ Ğ¿Ğ°Ñ€ÑĞµÑ€Ğ° + ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

return [{
	json: {
		source_video_url: sourceVideoUrl,
		shorts: deduplicated,
		stats: stats
	}
}];
