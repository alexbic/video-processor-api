// ðŸŽ® Gaming Templates v4.0 - ÐÐžÐ’ÐÐ¯ Ð²ÐµÑ€ÑÐ¸Ñ Ñ Ñ€Ð°Ð·Ð±Ð¾Ñ€Ð¾Ð¼ Title
// ÐŸÐ ÐÐ’Ð˜Ð›Ð¬ÐÐ«Ð™ Ð¤ÐžÐ ÐœÐÐ¢: ÐºÐ°Ð¶Ð´Ñ‹Ð¹ ÑÑƒÐ±Ñ‚Ð¸Ñ‚Ñ€ = Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ñ‹Ð¹ text_item
// (ÐÐ• Ð²Ð»Ð¾Ð¶ÐµÐ½Ð½Ñ‹Ð¹ subtitles.items, Ð° Ñ€Ð°Ð·Ð²Ñ‘Ñ€Ð½ÑƒÑ‚Ñ‹Ð¹ Ð¼Ð°ÑÑÐ¸Ð²)
// 
// Ð ÐÐ—ÐÐ˜Ð¦Ð ÐžÐ¢ LEGACY:
// - Title Ñ€Ð°Ð·Ð±Ð¸Ð²Ð°ÐµÑ‚ÑÑ Ð½Ð° Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð°Ñ‚Ð¾Ð¼Ñ‹ (ÐµÑÐ»Ð¸ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¾ ÑÑ‚Ñ€Ð¾Ðº)
// - ÐšÐ°Ð¶Ð´Ñ‹Ð¹ atom ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑÑ Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ñ‹Ð¼ text_item
// - Ð˜Ð´ÐµÐ°Ð»ÑŒÐ½Ð¾ Ð´Ð»Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ð¼Ð½Ð¾Ð³Ð¾ÑƒÑ€Ð¾Ð²Ð½ÐµÐ²Ñ‹Ñ… Ð·Ð°Ð³Ð¾Ð»Ð¾Ð²ÐºÐ¾Ð²
//
// Ð”Ð»Ñ ÑÑ‚Ð°Ñ€Ð¾Ð³Ð¾ Ð¿Ð¾Ð²ÐµÐ´ÐµÐ½Ð¸Ñ (Title ÐºÐ°Ðº ÐµÑÑ‚ÑŒ) Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ: workflow-code-v4-LEGACY.js

// âœ… Ð”ÐžÐ¡Ð¢Ð£ÐŸÐÐ«Ð• Ð¨Ð Ð˜Ð¤Ð¢Ð« Ð’ ÐŸÐ£Ð‘Ð›Ð˜Ð§ÐÐžÐ™ Ð’Ð•Ð Ð¡Ð˜Ð˜ (10 ÑˆÑ‚ÑƒÐº):
// 1. Charter.ttc - Modern Serif
// 2. Copperplate.ttc - Ð”ÐµÐºÐ¾Ñ€Ð°Ñ‚Ð¸Ð²Ð½Ñ‹Ð¹ ÑÑ‚Ð¸Ð»ÑŒ
// 3. HelveticaNeue.ttc - Premium Sans-Serif
// 4. LucidaGrande.ttc - Ð­Ð»ÐµÐ³Ð°Ð½Ñ‚Ð½Ñ‹Ð¹ Sans-Serif
// 5. MarkerFelt.ttc - ÐšÑ€ÐµÐ°Ñ‚Ð¸Ð²Ð½Ñ‹Ð¹ ÑÑ‚Ð¸Ð»ÑŒ
// 6. Menlo.ttc - Monospace
// 7. Monaco.ttf - Monospace
// 8. PTSans.ttc - Ð ÑƒÑÑÐºÐ¸Ð¹ ÑˆÑ€Ð¸Ñ„Ñ‚
// 9. Palatino.ttc - ÐšÐ»Ð°ÑÑÐ¸Ñ‡ÐµÑÐºÐ¸Ð¹ Serif
// 10. STIXTwoText-Italic.ttf - ÐÐ°ÑƒÑ‡Ð½Ñ‹Ð¹ (Math)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ðŸ“‹ Ð˜ÐÐ¡Ð¢Ð Ð£ÐšÐ¦Ð˜Ð¯: Ð’Ð¡Ð¢ÐÐ’ÐšÐ Ð¨ÐÐ‘Ð›ÐžÐÐžÐ’ Ð’ N8N
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//
// âš ï¸ Ð’ÐÐ–ÐÐž: Ð¨Ð°Ð±Ð»Ð¾Ð½Ñ‹ Ñ…Ñ€Ð°Ð½ÑÑ‚ÑÑ Ð² Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ð¾Ð¼ Ñ„Ð°Ð¹Ð»Ðµ templates-definitions.js
//
// ðŸ“ Ð¤Ð°Ð¹Ð» Ñ ÑˆÐ°Ð±Ð»Ð¾Ð½Ð°Ð¼Ð¸: n8n-examples/templates-definitions.js
//    Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ 60 ÑƒÐ½Ð¸Ð²ÐµÑ€ÑÐ°Ð»ÑŒÐ½Ñ‹Ñ… ÑˆÐ°Ð±Ð»Ð¾Ð½Ð¾Ð² Ð² 4 ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸ÑÑ…
//
// ðŸ”§ Ð˜ÐÐ¡Ð¢Ð Ð£ÐšÐ¦Ð˜Ð¯ ÐŸÐž Ð’Ð¡Ð¢ÐÐ’ÐšÐ•:
// 1. ÐžÑ‚ÐºÑ€Ð¾Ð¹Ñ‚Ðµ Ñ„Ð°Ð¹Ð» templates-definitions.js
// 2. Ð¡ÐºÐ¾Ð¿Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ Ð²ÐµÑÑŒ Ð¾Ð±ÑŠÐµÐºÑ‚ VIDEO_TEMPLATES (ÑÑ‚Ñ€Ð¾ÐºÐ¸ 39-1865)
// 3. Ð’ÑÑ‚Ð°Ð²ÑŒÑ‚Ðµ ÐµÐ³Ð¾ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ Ð’ÐœÐ•Ð¡Ð¢Ðž Ð¿ÑƒÑÑ‚Ð¾Ð³Ð¾ Ð¾Ð±ÑŠÐµÐºÑ‚Ð° Ð½Ð¸Ð¶Ðµ
//
// ðŸ“ Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð²Ñ‹Ð³Ð»ÑÐ´ÐµÑ‚ÑŒ Ñ‚Ð°Ðº:
//    const VIDEO_TEMPLATES = {
//       "cyber_neon": { name: "Cyber Neon", ... },
//       "fire_ice": { name: "Fire & Ice", ... },
//       ... (Ð²ÑÐµÐ³Ð¾ 60 ÑˆÐ°Ð±Ð»Ð¾Ð½Ð¾Ð²)
//    };
//
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// ðŸ‘‡ Ð’Ð¡Ð¢ÐÐ’Ð¬Ð¢Ð• Ð¡Ð®Ð”Ð Ð¡ÐžÐ”Ð•Ð Ð–Ð˜ÐœÐžÐ• VIDEO_TEMPLATES Ð˜Ð— templates-definitions.js
const VIDEO_TEMPLATES = {
	// Ð—Ð”Ð•Ð¡Ð¬ Ð‘Ð£Ð”Ð£Ð¢ Ð’ÐÐ¨Ð˜ 60 Ð¨ÐÐ‘Ð›ÐžÐÐžÐ’
	// Ð¡ÐºÐ¾Ð¿Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ Ð¾Ð±ÑŠÐµÐºÑ‚Ð° VIDEO_TEMPLATES Ð¸Ð· templates-definitions.js (ÑÑ‚Ñ€Ð¾ÐºÐ¸ 39-1865)
};

// =====================================================
// Ð¤Ð£ÐÐšÐ¦Ð˜Ð¯ Ð’Ð«Ð‘ÐžÐ Ð Ð¨ÐÐ‘Ð›ÐžÐÐ
// =====================================================
function selectTemplate(clientMeta) {
	let filteredTemplates = Object.entries(GAMING_TEMPLATES);

	// Ð¤Ð¸Ð»ÑŒÑ‚Ñ€ Ð¿Ð¾ Ñ‚Ð¾Ñ‡Ð½Ð¾Ð¼Ñƒ Ð¸Ð¼ÐµÐ½Ð¸ ÑˆÐ°Ð±Ð»Ð¾Ð½Ð°
	if (clientMeta.template_name && GAMING_TEMPLATES[clientMeta.template_name]) {
		filteredTemplates = [[clientMeta.template_name, GAMING_TEMPLATES[clientMeta.template_name]]];
	}
	// Ð¤Ð¸Ð»ÑŒÑ‚Ñ€ Ð¿Ð¾ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¸
	else if (clientMeta.template_category) {
		filteredTemplates = filteredTemplates.filter(([key, tpl]) =>
			tpl.category === clientMeta.template_category
		);
	}

	// Ð¤Ð¸Ð»ÑŒÑ‚Ñ€ Ð¿Ð¾ Ð¶Ð°Ð½Ñ€Ñƒ (ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ)
	if (clientMeta.template_genre && filteredTemplates.length > 1) {
		const genreFiltered = filteredTemplates.filter(([key, tpl]) =>
			tpl.best_for.includes(clientMeta.template_genre)
		);
		if (genreFiltered.length > 0) {
			filteredTemplates = genreFiltered;
		}
	}

	// Ð¡Ð»ÑƒÑ‡Ð°Ð¹Ð½Ñ‹Ð¹ Ð²Ñ‹Ð±Ð¾Ñ€ Ð¸Ð· Ð¾Ñ‚Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ñ…
	const [templateKey, tpl] = filteredTemplates[Math.floor(Math.random() * filteredTemplates.length)];
	return { templateKey, tpl, totalFiltered: filteredTemplates.length };
}

// =====================================================
// ÐŸÐ ÐÐ’Ð˜Ð›Ð¬ÐÐÐ¯ Ð¤Ð£ÐÐšÐ¦Ð˜Ð¯: Ñ€Ð°ÑÐºÑ€Ñ‹Ð²Ð°ÐµÑ‚ ÐºÐ°Ð¶Ð´Ñ‹Ð¹ ÑÑƒÐ±Ñ‚Ð¸Ñ‚Ñ€ Ð² text_item
// =====================================================
function createOperation(item, templateKey, tpl) {
	const data = item.json;
	const shorts = data.shorts || data;
	const clientMeta = shorts.client_meta || data.client_meta || {};
	const sourceUrl = data.source_video_url || shorts.source_video_url;

	// Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¼Ð°ÑÑÐ¸Ð² text_items
	const textItems = [];

	// Item 1: Title (Ð·Ð°Ð³Ð¾Ð»Ð¾Ð²Ð¾Ðº Ð²ÑÐµÐ³Ð´Ð°)
	textItems.push({
		text: shorts.title,
		fontfile: tpl.title.fontfile,
		fontsize: tpl.title.fontsize,
		fontcolor: tpl.title.fontcolor,
		x: tpl.title.x,
		y: tpl.title.y,
		start: 0.0,
		end: 999,  // Ð”Ð¾ ÐºÐ¾Ð½Ñ†Ð° Ð²Ð¸Ð´ÐµÐ¾
		box: tpl.title.box,
		boxcolor: tpl.title.boxcolor || undefined,
		boxborderw: tpl.title.boxborderw || undefined
	});

	// Items 2+: ÐšÐÐ–Ð”Ð«Ð™ Ð¡Ð£Ð‘Ð¢Ð˜Ð¢Ð  - Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ñ‹Ð¹ text_item Ñ Ð¾Ð´Ð¸Ð½Ð°ÐºÐ¾Ð²Ñ‹Ð¼Ð¸ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð°Ð¼Ð¸
	// Ð½Ð¾ Ñ€Ð°Ð·Ð½Ñ‹Ð¼Ð¸ Ñ‚ÐµÐºÑÑ‚Ð¾Ð¼ Ð¸ Ð²Ñ€ÐµÐ¼ÐµÐ½ÐµÐ¼
	if (shorts.subtitles && shorts.subtitles.length > 0) {
		shorts.subtitles.forEach((subtitleObj) => {
			// ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÐµÐ¼ Ð¾Ð±Ð° Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð°: Ð¿Ñ€Ð¾ÑÑ‚Ð¾Ð¹ Ñ‚ÐµÐºÑÑ‚ Ð¸Ð»Ð¸ Ð¾Ð±ÑŠÐµÐºÑ‚ Ñ timing
			const subtitleText = subtitleObj.text || subtitleObj;
			const startTime = subtitleObj.start !== undefined ? subtitleObj.start : 0;
			const endTime = subtitleObj.end !== undefined ? subtitleObj.end : (startTime + 5);

			textItems.push({
				text: subtitleText,
				fontfile: tpl.sub.fontfile,
				fontsize: tpl.sub.fontsize,
				fontcolor: tpl.sub.fontcolor,
				x: tpl.sub.x,
				y: tpl.sub.y,
				start: startTime,
				end: endTime,
				box: tpl.sub.box,
				boxcolor: tpl.sub.boxcolor || undefined,
				boxborderw: tpl.sub.boxborderw || undefined
			});
		});
	}

	return {
		json: {
			video_url: sourceUrl,
			execution: "async",
			operations: [{
				type: "make_short",
				start_time: shorts.start,
				end_time: shorts.end,
				crop_mode: "letterbox",
				letterbox_config: {
					blur_radius: 20
				},
				text_items: textItems,  // âœ… ÐŸÐ»Ð¾ÑÐºÐ¸Ð¹ Ð¼Ð°ÑÑÐ¸Ð², ÐºÐ°Ð¶Ð´Ñ‹Ð¹ ÑÑƒÐ±Ñ‚Ð¸Ñ‚Ñ€ = Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ñ‹Ð¹ item
				generate_thumbnail: true,
				thumbnail_timestamp: 0.5
			}],
			client_meta: {
				...clientMeta,
				_template_key: templateKey,
				_template_name: tpl.name,
				_template_category: tpl.category,
				_template_genres: tpl.best_for,
				_templates_available: 0,
				_input_item_index: item.index
			}
		}
	};
}

// =====================================================
// Ð“Ð›ÐÐ’ÐÐÐ¯ Ð›ÐžÐ“Ð˜ÐšÐ
// =====================================================
const items = $input.all();
const results = items.map((item) => {
	const clientMeta = (item.json.shorts || item.json).client_meta || item.json.client_meta || {};
	const { templateKey, tpl, totalFiltered } = selectTemplate(clientMeta);
	const operation = createOperation(item, templateKey, tpl);

	operation.json.client_meta._templates_available = totalFiltered;

	return operation;
});

return results;
