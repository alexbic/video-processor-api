# Example: Add these sections to your main docker-compose.yml

services:
  # Add Redis service
  redis:
    image: redis:7-alpine
    container_name: redis
    restart: unless-stopped
    expose:
      - "6379"
    volumes:
      - /opt/n8n-docker/volumes/redis_storage:/data
    networks:
      - n8n_net
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3

  # Update video-processor service
  video-processor:
    image: alexbic/video-processor-api:latest
    container_name: video-processor
    expose:
      - "5001"
    networks:
      - n8n_net
    volumes:
      - /opt/n8n-docker/volumes/video_processor/tasks:/app/tasks  # Task-based storage (input/temp/output + metadata.json)
      - /opt/n8n-docker/volumes/video_processor/fonts:/app/fonts/custom  # Custom fonts directory
    restart: unless-stopped
    environment:
      # Redis configuration (enable multi-worker mode)
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_DB: 0
      WORKERS: 2  # Can use 2+ workers with Redis
      # Public base URL for generating absolute download links (no trailing slash)
      # If set - API works in public mode, API_KEY becomes mandatory
      # If not set - API works in internal Docker network mode, API_KEY is optional
      PUBLIC_BASE_URL: https://alexbic.net/video-processor-api
      
      # API Key for authentication (Bearer token)
      # Required when PUBLIC_BASE_URL is set (public API mode)
      # Optional when PUBLIC_BASE_URL is not set (internal Docker network)
      # Generate secure key: openssl rand -hex 32
      API_KEY: your-secure-api-key-here-change-me
    depends_on:
      redis:
        condition: service_healthy

# Notes:
# 1. Redis uses append-only file (AOF) for persistence
# 2. maxmemory=256mb with LRU eviction (old tasks auto-deleted)
# 3. Tasks have 24h TTL in Redis
# 4. If Redis is unavailable, video-processor falls back to single-worker mode
# 5. Task-based storage: Each task creates /app/tasks/{task_id}/ with input/, temp/, output/, metadata.json
# 6. Files auto-delete after 2 hours (cleanup runs on each request)
# 7. Custom fonts: Place .ttf/.otf files in /opt/n8n-docker/volumes/video_processor/fonts/
#    They will be available inside container at /app/fonts/custom/
# 8. Download URLs format: /download/{task_id}/output/{filename} or /download/{task_id}/metadata.json
# 9. When serving behind a reverse proxy under a subpath, set PUBLIC_BASE_URL
#    to your full external base, e.g. https://example.com/video-processor-api
#    A trailing slash is optional; the app will normalize it.
# 10. API Key authentication: Smart auth logic based on PUBLIC_BASE_URL
#     - If PUBLIC_BASE_URL is set (public API): API_KEY is REQUIRED (shows warning if missing)
#     - If PUBLIC_BASE_URL is not set (internal Docker): API_KEY is optional
#     Generate secure key: openssl rand -hex 32
#     Usage: curl -H "Authorization: Bearer YOUR_API_KEY" https://your-api.com/endpoint
#     Endpoints without auth: /health, /task_status/{task_id}, /download/{task_id}/...
